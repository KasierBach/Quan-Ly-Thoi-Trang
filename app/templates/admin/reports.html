{% extends 'base.html' %}

{% block title %}B√°o c√°o th·ªëng k√™ - Admin - Fashion Store{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2">
                <div class="list-group admin-sidebar mb-4">
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a href="{{ url_for('chat.admin_chat_dashboard') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-comments me-2"></i>H·ªó tr·ª£ tr·ª±c tuy·∫øn
                    </a>
                    <a href="{{ url_for('admin.admin_products') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-box me-2"></i>S·∫£n ph·∫©m
                    </a>
                    <a href="{{ url_for('admin.admin_orders') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-shopping-cart me-2"></i>ƒê∆°n h√†ng
                    </a>
                    <a href="{{ url_for('admin.admin_comments') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-comments me-2"></i>B√¨nh lu·∫≠n
                    </a>
                    <a href="{{ url_for('admin.admin_reports') }}"
                        class="list-group-item list-group-item-action active">
                        <i class="fas fa-chart-bar me-2"></i>B√°o c√°o
                    </a>
                    <a href="{{ url_for('admin.admin_contact_messages') }}"
                        class="list-group-item list-group-item-action">
                        <i class="fas fa-envelope me-2"></i>Tin nh·∫Øn li√™n h·ªá
                    </a>
                    <a href="{{ url_for('admin.admin_customers') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-users me-2"></i>Qu·∫£n l√Ω kh√°ch h√†ng
                    </a>
                    <a href="{{ url_for('admin.admin_manage_products') }}"
                        class="list-group-item list-group-item-action">
                        <i class="fas fa-box me-2"></i>Qu·∫£n l√Ω s·∫£n ph·∫©m
                    </a>
                    <a href="{{ url_for('admin.admin_attributes') }}" class="list-group-item list-group-item-action">
                        <i class="fas fa-tags me-2"></i>Qu·∫£n l√Ω thu·ªôc t√≠nh
                    </a>
                    <a href="{{ url_for('main.home') }}" class="list-group-item list-group-item-action text-primary">
                        <i class="fas fa-store me-2"></i>Xem c·ª≠a h√†ng
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <!-- Page Header -->
                <div class="page-header animate__animated animate__fadeInDown">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-2">üìä B√°o c√°o chi ti·∫øt</h1>
                            <p class="mb-0 opacity-75">Ph√¢n t√≠ch d·ªØ li·ªáu kinh doanh v√† xu h∆∞·ªõng th·ªã tr∆∞·ªùng</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-light btn-custom me-2" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>In b√°o c√°o
                            </button>
                            <button class="btn btn-info btn-custom me-2" data-bs-toggle="modal"
                                data-bs-target="#emailReportModal">
                                <i class="fas fa-envelope me-2"></i>G·ª≠i Email
                            </button>
                            <button class="btn btn-warning btn-custom" onclick="exportToExcel()">
                                <i class="fas fa-download me-2"></i>Xu·∫•t Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Email Report Modal -->
                <div class="modal fade" id="emailReportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-envelope-open-text me-2"></i>G·ª≠i b√°o c√°o qua
                                    Email</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="emailReportForm">
                                    <div class="mb-3">
                                        <label class="form-label">Email ng∆∞·ªùi nh·∫≠n</label>
                                        <input type="email" class="form-control" name="email" required
                                            placeholder="nhanvien@example.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Lo·∫°i b√°o c√°o</label>
                                        <select class="form-select" name="report_type">
                                            <option value="daily_revenue">Doanh thu theo ng√†y</option>
                                            <option value="category_revenue">Doanh thu theo danh m·ª•c</option>
                                            <option value="best_selling">S·∫£n ph·∫©m b√°n ch·∫°y</option>
                                            <option value="top_customers">Kh√°ch h√†ng VIP</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">L·ªùi nh·∫Øn (t√πy ch·ªçn)</label>
                                        <textarea class="form-control" name="message" rows="3"
                                            placeholder="G·ª≠i s·∫øp b√°o c√°o th√°ng n√†y..."></textarea>
                                    </div>
                                    <input type="hidden" name="start_date" value="{{ start_date }}">
                                    <input type="hidden" name="end_date" value="{{ end_date }}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                <button type="button" class="btn btn-primary" onclick="sendEmailReport()">
                                    <i class="fas fa-paper-plane me-2"></i>G·ª≠i ngay
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Filter -->
                <div class="date-filter-card animate__animated animate__fadeInUp">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <form method="GET" class="row g-3 align-items-end" id="dateFilterForm">
                                <div class="col-md-3">
                                    <label for="start_date" class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-2"></i>T·ª´ ng√†y
                                    </label>
                                    <input type="date" class="form-control" id="start_date" name="start_date"
                                        value="{{ start_date }}" onchange="updateReport()">
                                </div>
                                <div class="col-md-3">
                                    <label for="end_date" class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-2"></i>ƒê·∫øn ng√†y
                                    </label>
                                    <input type="date" class="form-control" id="end_date" name="end_date"
                                        value="{{ end_date }}" onchange="updateReport()">
                                </div>
                                <div class="col-md-3">
                                    <label for="group_by" class="form-label fw-bold">
                                        <i class="fas fa-layer-group me-2"></i>Th·ªëng k√™ theo
                                    </label>
                                    <select class="form-select" id="group_by" name="group_by" onchange="updateReport()">
                                        <option value="day" {% if group_by=='day' %}selected{% endif %}>Theo Ng√†y
                                        </option>
                                        <option value="week" {% if group_by=='week' %}selected{% endif %}>Theo Tu·∫ßn
                                        </option>
                                        <option value="month" {% if group_by=='month' %}selected{% endif %}>Theo Th√°ng
                                        </option>
                                        <option value="year" {% if group_by=='year' %}selected{% endif %}>Theo NƒÉm
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary-custom btn-custom w-100">
                                        <i class="fas fa-search me-2"></i>T·∫°o b√°o c√°o
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="quick-actions">
                                <button class="quick-action-btn" onclick="setDateRange(7)">7 ng√†y</button>
                                <button class="quick-action-btn" onclick="setDateRange(30)">30 ng√†y</button>
                                <button class="quick-action-btn" onclick="setDateRange(90)">3 th√°ng</button>
                                <button class="quick-action-btn" onclick="setDateRange(365)">1 nƒÉm</button>
                                <button class="quick-action-btn" onclick="setDateRange('all')">T·∫•t c·∫£</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner"></div>

                <!-- Statistics Cards -->
                <div class="stats-grid animate__animated animate__fadeInUp">
                    <div class="stat-card revenue">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-value">{{ "{:,.0f}".format(total_revenue) }} ƒë</div>
                        <div class="stat-label">T·ªïng doanh thu</div>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up me-1"></i>+12.5%
                        </div>
                    </div>

                    <div class="stat-card orders">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-value">{{ total_orders }}</div>
                        <div class="stat-label">T·ªïng ƒë∆°n h√†ng</div>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up me-1"></i>+8.3%
                        </div>
                    </div>

                    <div class="stat-card customers">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value">
                            {% if new_customers %}
                            {{ new_customers }}
                            {% else %}
                            0
                            {% endif %}
                        </div>
                        <div class="stat-label">Kh√°ch h√†ng m·ªõi</div>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up me-1"></i>+15.7%
                        </div>
                    </div>

                    <div class="stat-card products">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-value">{{ best_selling|length }}</div>
                        <div class="stat-label">S·∫£n ph·∫©m b√°n ch·∫°y</div>
                        <div class="trend-indicator trend-up">
                            <i class="fas fa-arrow-up me-1"></i>+5.2%
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row">
                    <!-- Revenue Chart -->
                    <div class="col-lg-8 mb-4">
                        <div class="chart-card animate__animated animate__fadeInLeft">
                            <div class="chart-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Xu h∆∞·ªõng doanh thu theo th·ªùi gian
                                </h5>
                            </div>
                            <div class="chart-body">
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Chart -->
                    <div class="col-lg-4 mb-4">
                        <div class="chart-card animate__animated animate__fadeInRight">
                            <div class="chart-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>Doanh thu theo danh m·ª•c
                                </h5>
                            </div>
                            <div class="chart-body">
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="row">
                    <!-- Best Selling Products -->
                    <div class="col-lg-6 mb-4">
                        <div class="table-card animate__animated animate__fadeInUp">
                            <div class="table-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-trophy me-2"></i>Top s·∫£n ph·∫©m b√°n ch·∫°y
                                </h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table custom-table">
                                    <thead>
                                        <tr>
                                            <th>H·∫°ng</th>
                                            <th>S·∫£n ph·∫©m</th>
                                            <th>ƒê√£ b√°n</th>
                                            <th>Doanh thu</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product in best_selling[:10] %}
                                        <tr>
                                            <td>
                                                <span
                                                    class="badge-rank {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-other{% endif %}">
                                                    {{ loop.index }}
                                                </span>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>{{ product.ProductName[:25] }}{% if
                                                        product.ProductName|length > 25 %}...{% endif %}</strong>
                                                    <br><small class="text-muted">{{ product.CategoryName }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">{{ product.TotalSold }}</span>
                                            </td>
                                            <td>
                                                <strong class="text-success">{{
                                                    "{:,.0f}".format(product.TotalRevenue|default(0)) }} ƒë</strong>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% if not best_selling %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Performance -->
                    <div class="col-lg-6 mb-4">
                        <div class="table-card animate__animated animate__fadeInUp">
                            <div class="table-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-calendar-day me-2"></i>Hi·ªáu su·∫•t theo ng√†y
                                </h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table custom-table">
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>ƒê∆°n h√†ng</th>
                                            <th>Doanh thu</th>
                                            <th>Hi·ªáu su·∫•t</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for day in daily_revenue[:10] %}
                                        <tr>
                                            <td>
                                                <strong>{{ day.OrderDate.strftime('%d/%m/%Y') }}</strong>
                                                <br><small class="text-muted">{{ day.OrderDate.strftime('%A') }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ day.OrderCount }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ "{:,.0f}".format(day.DailyRevenue) }} ƒë</strong>
                                            </td>
                                            <td>
                                                {% if daily_revenue|length > 0 %}
                                                {% set avg_revenue = total_revenue|float / daily_revenue|length %}
                                                {% set performance = (day.DailyRevenue|float / avg_revenue) * 100 if
                                                avg_revenue != 0 else 0 %}
                                                {% if performance > 120 %}
                                                <span class="performance-badge performance-excellent">Xu·∫•t s·∫Øc</span>
                                                {% elif performance > 80 %}
                                                <span class="performance-badge performance-good">T·ªët</span>
                                                {% else %}
                                                <span class="performance-badge performance-average">Trung b√¨nh</span>
                                                {% endif %}
                                                {% else %}
                                                <span class="performance-badge performance-average">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% if not daily_revenue %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Analysis -->
                <div class="chart-card animate__animated animate__fadeInUp">
                    <div class="chart-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tags me-2"></i>Ph√¢n t√≠ch chi ti·∫øt theo danh m·ª•c
                        </h5>
                    </div>
                    <div class="chart-body">
                        <div class="row align-items-center">
                            <div class="col-12">
                                <div class="row">
                                    {% for category in category_revenue %}
                                    {% set colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD',
                                    '#98D8C8', '#F7DC6F'] %}
                                    <div class="col-md-4 mb-3">
                                        <div class="category-item"
                                            data-border-color="{{ colors[loop.index0 % colors|length] }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1 fw-bold">{{ category.CategoryName }}</h6>
                                                    <small class="text-muted">
                                                        {% if total_revenue|float > 0 %}
                                                        {{ "{:.1f}".format((category.CategoryRevenue|float /
                                                        total_revenue|float) * 100) }}%
                                                        t·ªïng doanh thu
                                                        {% else %}
                                                        0% t·ªïng doanh thu
                                                        {% endif %}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <strong class="text-primary">{{
                                                        "{:,.0f}".format(category.CategoryRevenue) }} ƒë</strong>
                                                </div>
                                            </div>
                                            <div class="progress mt-2" style="height: 6px;">
                                                <div class="progress-bar"
                                                    data-width="{% if total_revenue|float > 0 %}{{ (category.CategoryRevenue|float / total_revenue|float) * 100 }}{% else %}0{% endif %}"
                                                    data-bg-color="{{ colors[loop.index0 % colors|length] }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% if not category_revenue %}
                                    <div class="col-12">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-chart-pie fa-3x mb-3 opacity-50"></i>
                                            <p>Kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c trong kho·∫£ng th·ªùi gian n√†y</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="export-section animate__animated animate__fadeInUp">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-3">
                                <i class="fas fa-download me-2"></i>Xu·∫•t b√°o c√°o
                            </h5>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-success-custom btn-custom" onclick="exportToCSV()">
                                    <i class="fas fa-file-csv me-2"></i>CSV
                                </button>
                                <button class="btn btn-warning-custom btn-custom" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf me-2"></i>PDF
                                </button>
                                <button class="btn btn-info-custom btn-custom" onclick="emailReport()">
                                    <i class="fas fa-envelope me-2"></i>Email
                                </button>
                                <button class="btn btn-primary-custom btn-custom" onclick="scheduleReport()">
                                    <i class="fas fa-clock me-2"></i>L√™n l·ªãch
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="text-muted">
                                <p class="mb-1">
                                    <i class="fas fa-clock me-2"></i>
                                    B√°o c√°o ƒë∆∞·ª£c t·∫°o: {{ (now or None)|default('N/A', true) if not now else
                                    now.strftime('%d/%m/%Y %H:%M:%S') }}
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-calendar me-2"></i>
                                    Kho·∫£ng th·ªùi gian: {{ start_date }} ƒë·∫øn {{ end_date }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Email Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>G·ª≠i b√°o c√°o qua Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="emailForm">
                        <div class="mb-3">
                            <label class="form-label">Lo·∫°i b√°o c√°o</label>
                            <select class="form-select" id="reportType">
                                <option value="daily_revenue">üìä Doanh thu theo ng√†y</option>
                                <option value="best_selling">üì¶ S·∫£n ph·∫©m b√°n ch·∫°y</option>
                                <option value="category_revenue">üìÇ Doanh thu theo danh m·ª•c</option>
                                <option value="top_customers">üë• Kh√°ch h√†ng VIP</option>
                                <option value="low_stock">üìâ T·ªìn kho th·∫•p</option>
                                <option value="order_details">üìã Chi ti·∫øt ƒë∆°n h√†ng</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email ng∆∞·ªùi nh·∫≠n</label>
                            <input type="email" class="form-control" id="reportEmail" placeholder="example@gmail.com"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">L·ªùi nh·∫Øn (t√πy ch·ªçn)</label>
                            <textarea class="form-control" rows="3"
                                placeholder="G·ª≠i k√®m l·ªùi nh·∫Øn cho ng∆∞·ªùi nh·∫≠n..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="sendEmailReal()">G·ª≠i ngay</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-clock me-2"></i>L√™n l·ªãch b√°o c√°o t·ª± ƒë·ªông</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">T·∫ßn su·∫•t g·ª≠i</label>
                        <select class="form-select" id="scheduleFreq">
                            <option value="H√†ng ng√†y">H√†ng ng√†y (08:00 AM)</option>
                            <option value="H√†ng tu·∫ßn">H√†ng tu·∫ßn (Th·ª© Hai)</option>
                            <option value="H√†ng th√°ng">H√†ng th√°ng (Ng√†y 01)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i b√°o c√°o</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked disabled>
                            <label class="form-check-label">T·ªïng h·ª£p doanh thu</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">Chi ti·∫øt ƒë∆°n h√†ng</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox">
                            <label class="form-check-label">Ph√¢n t√≠ch danh m·ª•c</label>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label">Email nh·∫≠n b√°o c√°o</label>
                        <input type="email" class="form-control" value="admin@fashionstore.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSchedule()">X√°c nh·∫≠n l√™n l·ªãch</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script type="text/template" id="csv-data">
    [
        {% for day in daily_revenue %}
        {
            "date": "{{ day.OrderDate.strftime('%d/%m/%Y') }}",
            "count": {{ day.OrderCount }},
            "revenue": {{ day.DailyRevenue }}
        }{{ "," if not loop.last }}
        {% endfor %}
    ]
</script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script type="text/template" id="chart-data">
    {
        "dailyLabels": {{ dates|tojson }},
        "dailyData": {{ revenues|tojson }},
        "categoryLabels": {{ category_names|tojson }},
        "categoryData": {{ category_revenues|tojson }}
    }
</script>
<script type="text/template" id="report-config">
    {
        "startDate": "{{ start_date }}",
        "endDate": "{{ end_date }}"
    }
</script>
<script>
    // D·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
    const chartData = JSON.parse(document.getElementById('chart-data').textContent);
    const dailyLabels = chartData.dailyLabels;
    const dailyData = chartData.dailyData;
    const categoryLabels = chartData.categoryLabels;
    const categoryData = chartData.categoryData;

    // M√†u s·∫Øc cho bi·ªÉu ƒë·ªì
    const chartColors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
        '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'
    ];

    // Bi·ªÉu ƒë·ªì doanh thu
    const revenueChart = new Chart(
        document.getElementById('revenueChart'),
        {
            type: 'line',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Doanh thu',
                    data: dailyData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    // Hide points if too many data points (e.g. > 50)
                    pointRadius: dailyLabels.length > 50 ? 0 : 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1.5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#667eea',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 14 },
                        displayColors: false,
                        callbacks: {
                            label: function (context) {
                                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f1f5f9',
                            drawBorder: false
                        },
                        ticks: {
                            font: { size: 11, family: "'Inter', sans-serif" },
                            callback: function (value) {
                                if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
                                return value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: { size: 11 },
                            maxTicksLimit: 12, // More spread out
                            maxRotation: 0,
                            autoSkip: true
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest',
                    axis: 'x'
                }
            }
        }
    );

    // Bi·ªÉu ƒë·ªì danh m·ª•c
    const categoryChart = new Chart(
        document.getElementById('categoryChart'),
        {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: chartColors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function (value, context) {
                            let sum = 0;
                            let dataArr = context.chart.data.datasets[0].data;
                            dataArr.map(data => {
                                sum += data;
                            });
                            const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                            return percentage;
                        },
                        display: function (context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        }
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                family: "'Inter', sans-serif"
                            },
                            generateLabels: function (chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const dataset = data.datasets[0];
                                    const total = dataset.data.reduce((acc, val) => acc + val, 0);

                                    return data.labels.map((label, i) => {
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                        return {
                                            text: `${label} (${percentage})`,
                                            fillStyle: dataset.backgroundColor[i],
                                            hidden: isNaN(dataset.data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                            index: i,
                                            strokeStyle: dataset.backgroundColor[i],
                                            lineWidth: 0
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#667eea',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        bodyFont: { size: 14 },
                        displayColors: true,
                        callbacks: {
                            label: function (context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const value = context.raw;
                                const total = context.chart._metasets[context.datasetIndex].total;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
                                return `${label} (${percentage})`;
                            }
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        }
    );

    // Utility functions
    function setDateRange(days) {
        const endDate = new Date();
        const groupBySelect = document.getElementById('group_by');

        if (days === 'all') {
            document.getElementById('start_date').value = '';
            // Auto-switch to Month if "All Time" is selected for better readability
            groupBySelect.value = 'month';
        } else {
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - days);
            document.getElementById('start_date').value = startDate.toISOString().split('T')[0];

            // Auto-switch back to Day for short ranges (e.g. 7 or 30 days)
            if (days <= 60) {
                groupBySelect.value = 'day';
            }
        }

        document.getElementById('end_date').value = endDate.toISOString().split('T')[0];

        // Auto submit form
        document.getElementById('dateFilterForm').submit();
    }

    function updateReport() {
        showLoading();
        setTimeout(() => {
            document.getElementById('dateFilterForm').submit();
        }, 500);
    }

    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // Export functions
    function exportToCSV() {
        showNotification('ƒêang chu·∫©n b·ªã file CSV...', 'info');

        // L·∫•y d·ªØ li·ªáu t·ª´ script tag
        const csvData = JSON.parse(document.getElementById('csv-data').textContent);

        // T·∫°o header
        let csvContent = "Ng√†y,S·ªë ƒë∆°n h√†ng,Doanh thu (VNƒê)\n";

        // Th√™m d·ªØ li·ªáu
        csvData.forEach(day => {
            csvContent += `${day.date},${day.count},${day.revenue}\n`;
        });

        // S·ª≠ d·ª•ng BOM ƒë·ªÉ Excel nh·∫≠n d·∫°ng ti·∫øng Vi·ªát (UTF-8)
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        const reportConfig = JSON.parse(document.getElementById('report-config').textContent);
        const fileName = `bao_cao_doanh_thu_${reportConfig.startDate}_den_${reportConfig.endDate}.csv`;

        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification('ƒê√£ xu·∫•t file CSV th√†nh c√¥ng!', 'success');
    }

    function exportToPDF() {
        showNotification('ƒêang chu·∫©n b·ªã b·∫£n in PDF...', 'info');
        setTimeout(() => {
            window.print();
        }, 500);
    }

    function exportToExcel() {
        showNotification('ƒêang xu·∫•t d·ªØ li·ªáu sang Excel...', 'info');
        // S·ª≠ d·ª•ng h√†m export CSV v√¨ n√≥ ƒë√£ t∆∞∆°ng th√≠ch t·ªët v·ªõi Excel th√¥ng qua BOM
        exportToCSV();
    }

    const emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
    const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));

    function emailReport() {
        emailModal.show();
    }

    function scheduleReport() {
        scheduleModal.show();
    }

    function sendEmailReport() {
        const form = document.getElementById('emailReportForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const emailModalElement = document.getElementById('emailReportModal');
        const modal = bootstrap.Modal.getInstance(emailModalElement) || new bootstrap.Modal(emailModalElement);

        if (!data.email || !data.email.includes('@')) {
            showNotification('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá', 'warning');
            return;
        }

        const btn = document.querySelector('#emailReportModal .btn-primary');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang g·ª≠i...';

        fetch('/admin/api/send_report_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(result.message, 'success');
                    modal.hide();
                    form.reset();
                } else {
                    showNotification(result.message, 'danger');
                }
            })
            .catch(err => {
                console.error(err);
                showNotification('L·ªói khi g·ª≠i b√°o c√°o: ' + err, 'danger');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }

    function confirmSchedule() {
        // Mock function for future schedule feature
        const freq = document.getElementById('scheduleFreq').value;
        showNotification(`T√≠nh nƒÉng l√™n l·ªãch b√°o c√°o ${freq} ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!`, 'info');
        bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        hideLoading();

        // Add animation to cards on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        });

        document.querySelectorAll('.animate__animated').forEach(el => {
            observer.observe(el);
        });

        // Apply dynamic styles from data attributes to avoid syntax errors
        document.querySelectorAll('.category-item[data-border-color]').forEach(el => {
            el.style.borderLeftColor = el.getAttribute('data-border-color');
        });
        document.querySelectorAll('.progress-bar[data-width]').forEach(el => {
            el.style.width = el.getAttribute('data-width') + '%';
            el.style.backgroundColor = el.getAttribute('data-bg-color');
        });
    });

    // Auto-refresh data every 5 minutes
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            location.reload();
        }
    }, 300000);
</script>
{% endblock %}