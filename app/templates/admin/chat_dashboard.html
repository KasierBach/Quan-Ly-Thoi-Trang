{% extends 'base.html' %}

{% block title %}Hỗ trợ trực tuyến - Admin{% endblock %}

{% block styles %}
<style>
    .admin-chat-container {
        display: flex;
        height: calc(100vh - 56px);
        background: #f8f9fa;
        overflow: hidden;
    }

    .chat-sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }

    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f0f2f5;
    }

    .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        background: #fff;
    }

    .conversation-list {
        flex: 1;
        overflow-y: auto;
    }

    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #f1f1f1;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .conversation-item:hover,
    .conversation-item.active {
        background-color: #e9ecef;
    }

    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF6B6B 0%, #EE4D2D 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .conv-info {
        flex: 1;
        overflow: hidden;
    }

    .conv-name {
        font-weight: 600;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .conv-preview {
        font-size: 0.85rem;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-header {
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 60%;
        padding: 10px 15px;
        border-radius: 15px;
        position: relative;
        word-wrap: break-word;
    }

    .message.user {
        align-self: flex-start;
        background: white;
        border-bottom-left-radius: 2px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .message.admin {
        align-self: flex-end;
        background: #0084ff;
        color: white;
        border-bottom-right-radius: 2px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
    }

    .chat-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #dee2e6;
        display: flex;
        gap: 10px;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-chat-container">
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Tin nhắn khách hàng</h5>
        </div>
        <div class="conversation-list" id="conversationList">
            <!-- Items populated by JS -->
            <div class="text-center py-4 text-muted">Đang tải...</div>
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header" id="chatHeader" style="display: none;">
            <div class="avatar" id="currentAvatar">G</div>
            <div>
                <div class="conv-name" id="currentName">Guest</div>
                <div class="small text-muted"><span class="status-dot"></span>Đang online</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <i class="fas fa-comment-dots fa-3x mb-3"></i>
                <h5>Chọn một cuộc hội thoại để bắt đầu chat</h5>
            </div>
        </div>

        <div class="chat-input-area" id="chatInputArea" style="display: none;">
            <input type="text" class="form-control rounded-pill" id="messageInput" placeholder="Nhập tin nhắn..."
                onkeypress="handleKeyPress(event)">
            <button class="btn btn-primary rounded-circle" style="width: 40px; height: 40px;" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    let currentSessionId = null;
    let refreshInterval = null;

    // Load Conversations
    async function loadConversations() {
        try {
            const response = await fetch('/admin/chat/conversations?v=' + new Date().getTime());
            const data = await response.json();

            if (data.conversations) {
                const list = document.getElementById('conversationList');
                // Don't fully rebuild if not changed to prevent flicker? 
                // For MVP, just rebuild.

                // Save current selection
                const wasSelected = currentSessionId;

                list.innerHTML = '';
                data.conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${conv.session_id === currentSessionId ? 'active' : ''}`;
                    item.onclick = () => selectConversation(conv.session_id, conv.user_id);

                    const name = conv.user_id ? `User #${conv.user_id}` : `Guest ${conv.session_id.substr(0, 4)}`;
                    const time = new Date(conv.last_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    item.innerHTML = `
                        <div class="avatar">${name.charAt(0)}</div>
                        <div class="conv-info">
                            <div class="d-flex justify-content-between">
                                <span class="conv-name">${name}</span>
                                <small class="text-muted">${time}</small>
                            </div>
                            <div class="conv-preview ${conv.last_sender === 'user' ? 'fw-bold text-dark' : ''}">
                                ${conv.last_sender === 'admin' ? 'Bạn: ' : ''}${conv.last_message}
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function selectConversation(sessionId, userId) {
        currentSessionId = sessionId;
        document.getElementById('chatHeader').style.display = 'flex';
        document.getElementById('chatInputArea').style.display = 'flex';

        const name = userId ? `User #${userId}` : `Guest ${sessionId.substr(0, 4)}`;
        document.getElementById('currentName').textContent = name;
        document.getElementById('currentAvatar').textContent = name.charAt(0);

        // Highlight in list
        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
        // Re-load list to apply active class properly (lazy way) or just find matching element
        await loadMessages();
    }

    async function loadMessages() {
        if (!currentSessionId) return;

        try {
            const response = await fetch(`/api/chat/history?session_id=${currentSessionId}`);
            const data = await response.json();

            const container = document.getElementById('chatMessages');
            container.innerHTML = ''; // Clear

            data.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender_type}`;
                const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                div.innerHTML = `
                    ${msg.content}
                    <div class="message-time">${time}</div>
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        } catch (e) {
            console.error(e);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        if (!content || !currentSessionId) return;

        try {
            const response = await fetch('/api/chat/admin/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                body: JSON.stringify({
                    content: content,
                    session_id: currentSessionId
                })
            });

            if (response.ok) {
                input.value = '';
                loadMessages();
                loadConversations(); // Update preview
            }
        } catch (e) {
            alert('Lỗi gửi tin nhắn');
        }
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    // Poll every 3 seconds
    setInterval(() => {
        loadConversations();
        if (currentSessionId) loadMessages();
    }, 3000);

    // Initial load
    loadConversations();
</script>
{% endblock %}