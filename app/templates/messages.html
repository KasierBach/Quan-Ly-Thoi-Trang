{% extends 'base.html' %}

{% block title %}Tin nh·∫Øn{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}?v={{ range(1, 10000) | random }}">
{% endblock %}


{% block chat_widget %}{% endblock %}
{% block floating_contact_widget %}{% endblock %}

{% block content %}
<div class="messenger-container">
    <!-- Sidebar -->
    <div class="msg-sidebar">
        <div class="sidebar-header">
            <div class="header-top">
                <h4>Chat</h4>
                <div class="header-actions">
                    <button class="header-btn" title="New Message" id="btnCreateGroup">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="header-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="T√¨m ki·∫øm tr√™n Messenger" id="sidebarSearchInput">
                <div class="search-results" id="searchResults">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>

        <div class="conversation-list" id="conversationList">
            <!-- Conversations populated by JS -->
            <div class="text-center p-4 text-muted">
                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="msg-main">
        <div class="welcome-screen" id="welcomeScreen">
            <i class="fab fa-facebook-messenger"></i>
            <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Messenger</h3>
            <p>Ch·ªçn m·ªôt ƒëo·∫°n chat ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin.</p>
        </div>

        <div id="activeChatContainer">
            <div class="msg-chat-header">
                <div class="header-avatar" id="currentChatAvatar">?</div>
                <div class="chat-header-info">
                    <h5 id="currentChatName">User Name</h5>
                    <span class="status" id="headerStatus">ƒêang ho·∫°t ƒë·ªông</span>
                </div>
                <div class="chat-header-actions">
                    <button title="Call" id="btnCall"><i class="fas fa-phone-alt"></i></button>
                    <button title="Video Call" id="btnVideo"><i class="fas fa-video"></i></button>
                    <button title="Information" id="toggleInfoBtn"><i class="fas fa-info-circle"></i></button>
                </div>
            </div>

            <div class="pinned-shelf" id="pinnedShelf">
                <div class="pinned-icon"><i class="fas fa-thumbtack"></i></div>
                <div class="pinned-content" id="pinnedContent"></div>
                <div class="pinned-close" id="closePinnedBtn"><i class="fas fa-times"></i></div>
            </div>

            <div class="messages-area" id="messagesArea">
                <!-- Messages populated by JS -->
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span id="typingName" style="margin-right: 8px; font-weight: 500;"></span>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>

            <div class="chat-input-area">
                <div class="reply-preview-shelf" id="replyShelf">
                    <div class="reply-content">
                        <i class="fas fa-reply"></i>
                        <div class="reply-text">
                            <span class="reply-user" id="replyUserName">Gh√© thƒÉm</span>
                            <span class="reply-msg" id="replyMsgPreview">N·ªôi dung...</span>
                        </div>
                    </div>
                    <button class="cancel-reply" id="cancelReplyBtn"><i class="fas fa-times"></i></button>
                </div>

                <div class="input-main-row">
                    <div class="input-actions">
                        <button title="Add File" id="attachFileBtn"><i class="fas fa-plus-circle"></i></button>
                        <input type="file" id="fileInput" hidden>
                        <input type="file" id="imageInput" accept="image/*" hidden>
                        <button title="Choose Image" id="attachImageBtn"><i class="fas fa-image"></i></button>
                        <button title="Choose Sticker" id="stickerBtn"><i class="fas fa-sticky-note"></i></button>
                        <button title="Choose GIF" id="gifBtn"><i class="fas fa-gift"></i></button>
                        <button title="Voice Message" id="micBtn"><i class="fas fa-microphone"></i></button>
                    </div>

                    <!-- Recording UI -->
                    <div class="recording-ui" id="recordingUI">
                        <button class="btn-cancel-record btn-record-action" id="cancelRecordBtn"><i
                                class="fas fa-times"></i></button>
                        <div class="recording-timer" id="recordingTimer">00:00</div>
                        <button class="btn-send-record btn-record-action" id="sendRecordBtn"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>

                    <div class="message-input-wrapper">
                        <input type="text" class="message-input" placeholder="Aa" id="messageInput">
                        <div class="input-right-actions">
                            <button title="Choose Emoji" id="emojiBtn"><i class="fas fa-smile"></i></button>
                            <button title="Send Like" id="likeBtn"><i class="fas fa-thumbs-up"></i></button>
                        </div>
                        <!-- Emoji Picker -->
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-picker-header">
                                <input type="text" class="emoji-search" placeholder="Search emoji...">
                            </div>
                            <div class="emoji-grid-container">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>

                <!-- Sticker Picker -->
                <div class="sticker-picker" id="stickerPicker">
                    <div class="sticker-grid" id="stickerGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Info Panel -->
    <div class="msg-info-panel" id="infoPanel">
        <div class="info-header">
            <div class="info-avatar" id="infoPanelAvatar">?</div>
            <div class="info-name" id="infoPanelName">User Name</div>
            <div class="info-status" id="infoPanelStatus">ƒêang ho·∫°t ƒë·ªông</div>
        </div>
        <div class="info-actions">
            <div class="info-action-btn" id="btnInfoProfile">
                <div class="icon"><i class="fas fa-user"></i></div>
                <span>Trang c√° nh√¢n</span>
            </div>
            <div class="info-action-btn" id="btnInfoMute">
                <div class="icon"><i class="fas fa-bell"></i></div>
                <span id="muteText">T·∫Øt th√¥ng b√°o</span>
            </div>
            <div class="info-action-btn" id="btnInfoSearch">
                <div class="icon"><i class="fas fa-search"></i></div>
                <span>T√¨m ki·∫øm</span>
            </div>
        </div>
        <!-- Info Sections -->
        <div class="info-section open">
            <div class="info-section-title">
                <span>T√πy ch·ªânh ƒëo·∫°n chat</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="info-section-content">
                <div class="info-item" id="btnInfoTheme"><i class="fas fa-circle"
                        style="color: var(--messenger-blue)"></i> ƒê·ªïi ch·ªß ƒë·ªÅ
                </div>
                <div class="info-item" id="btnInfoEmoji"><i class="fas fa-thumbs-up"></i> Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c
                </div>
                <div class="info-item" id="btnInfoNickname"><i class="fas fa-pen"></i> Bi·ªát danh</div>
            </div>
        </div>

        <div class="info-section" id="groupMembersSection" style="display: none;">
            <div class="info-section-title">
                <span>Th√†nh vi√™n nh√≥m</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="info-section-content" id="groupMembersList">
                <!-- Managed by JS -->
            </div>
        </div>

        <div class="info-section">
            <div class="info-section-title">
                <span>File ph∆∞∆°ng ti·ªán & file</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="info-section-content">
                <div class="info-item" id="btnInfoMedia"><i class="fas fa-image"></i> File ph∆∞∆°ng ti·ªán</div>
                <div class="info-item" id="btnInfoFiles"><i class="fas fa-file"></i> File</div>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="image-viewer-modal" id="imageViewerModal">
    <div class="viewer-header">
        <div class="viewer-info" id="viewerInfo">1 / 1</div>
    </div>

    <div class="viewer-content" id="viewerContent">
        <img src="" alt="Full size" id="viewerImage">
    </div>

    <button class="viewer-nav prev" id="viewerPrevBtn" title="·∫¢nh tr∆∞·ªõc (M≈©i t√™n tr√°i)"><i
            class="fas fa-chevron-left"></i></button>
    <button class="viewer-nav next" id="viewerNextBtn" title="·∫¢nh sau (M≈©i t√™n ph·∫£i)"><i
            class="fas fa-chevron-right"></i></button>

    <button class="viewer-close" id="viewerCloseBtn" title="ƒê√≥ng (Esc)"><i class="fas fa-times"></i></button>

    <div class="viewer-controls">
        <button id="zoomInBtn" title="Ph√≥ng to"><i class="fas fa-search-plus"></i></button>
        <button id="zoomOutBtn" title="Thu nh·ªè"><i class="fas fa-search-minus"></i></button>
        <button id="resetBtn" title="ƒê·∫∑t l·∫°i"><i class="fas fa-sync-alt"></i></button>
        <button id="rotateLeftBtn" title="Xoay tr√°i (L)"><i class="fas fa-undo"></i></button>
        <button id="rotateRightBtn" title="Xoay ph·∫£i (R)"><i class="fas fa-redo"></i></button>
        <button id="flipHBtn" title="L·∫≠t ngang (H)"><i class="fas fa-arrows-alt-h"></i></button>
        <button id="downloadBtn" title="T·∫£i xu·ªëng"><i class="fas fa-download"></i></button>
    </div>
</div>

<!-- Context Custom Menus -->
<div class="context-menu" id="msgContextMenu">
    <div class="context-menu-item" onclick="window.reactMsg('‚ù§Ô∏è')"><i class="fas fa-heart"></i> Th·∫£ tim</div>
    <div class="context-menu-item" onclick="window.reactMsg('üòÜ')"><i class="fas fa-laugh"></i> Haha</div>
    <div class="context-menu-item" id="ctxPinBtn" onclick="window.handlePin()"><i class="fas fa-thumbtack"></i> Ghim tin
        nh·∫Øn</div>
    <div class="context-menu-item" id="ctxUnpinBtn" onclick="window.handleUnpin()"><i class="fas fa-thumbtack"></i> B·ªè
        ghim</div>
    <div class="context-menu-item danger" onclick="window.handleRecall()"><i class="fas fa-trash"></i> Thu h·ªìi</div>
</div>

<div class="context-menu" id="convContextMenu">
    <div class="context-menu-item" onclick="window.handleMarkRead()"><i class="fas fa-check-double"></i> ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
    </div>
    <div class="context-menu-item danger" onclick="window.handleDeleteConv()"><i class="fas fa-trash"></i> X√≥a cu·ªôc tr√≤
        chuy·ªán</div>
</div>

<!-- Group Modal -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>T·∫°o nh√≥m m·ªõi</h3>
            <span class="close" id="closeGroupModal" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="groupName" placeholder="T√™n nh√≥m...">
            <!-- Future: Member selection list -->
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="closeGroupModal">H·ªßy</button>
            <button class="btn-primary" id="btnSubmitGroup">T·∫°o nh√≥m</button>
        </div>
    </div>
</div>

<!-- Theme Modal -->
<div id="themeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ƒê·ªïi ch·ªß ƒë·ªÅ</h3>
            <span class="close" onclick="document.getElementById('themeModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <div class="theme-grid"
                style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px;">
                <div class="theme-option" data-color="#0084ff"
                    style="background: #0084ff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#fa3c4c"
                    style="background: #fa3c4c; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#ff7e29"
                    style="background: #ff7e29; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#e68585"
                    style="background: #e68585; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#7646ff"
                    style="background: #7646ff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#20cef5"
                    style="background: #20cef5; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#67fa94"
                    style="background: #67fa94; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#ff6699"
                    style="background: #ff6699; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#ffcc00"
                    style="background: #ffcc00; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
                <div class="theme-option" data-color="#888888"
                    style="background: #888888; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Nickname Modal -->
<div id="nicknameModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ch·ªânh s·ª≠a bi·ªát danh</h3>
            <span class="close" onclick="document.getElementById('nicknameModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" id="nicknameListBody">
            <!-- Populated by JS -->
        </div>
        <div class="modal-footer">
            <button class="btn-primary"
                onclick="document.getElementById('nicknameModal').style.display='none'">Xong</button>
        </div>
    </div>
</div>

<!-- Default Emoji Modal -->
<div id="emojiDefaultModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c</h3>
            <span class="close"
                onclick="document.getElementById('emojiDefaultModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <div class="emoji-default-grid" id="emojiDefaultGrid">
                <div class="emoji-default-option" data-emoji="üëç">üëç</div>
                <div class="emoji-default-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                <div class="emoji-default-option" data-emoji="üòÇ">üòÇ</div>
                <div class="emoji-default-option" data-emoji="üòÆ">üòÆ</div>
                <div class="emoji-default-option" data-emoji="üò¢">üò¢</div>
                <div class="emoji-default-option" data-emoji="üò°">üò°</div>
                <div class="emoji-default-option" data-emoji="üî•">üî•</div>
                <div class="emoji-default-option" data-emoji="üéâ">üéâ</div>
                <div class="emoji-default-option" data-emoji="üíØ">üíØ</div>
                <div class="emoji-default-option" data-emoji="üôè">üôè</div>
                <div class="emoji-default-option" data-emoji="üí™">üí™</div>
                <div class="emoji-default-option" data-emoji="‚ú®">‚ú®</div>
            </div>
        </div>
    </div>
</div>

<!-- Media Browser Modal -->
<div id="mediaBrowserModal" class="modal">
    <div class="modal-content large" style="max-width: 800px; width: 90%;">
        <div class="modal-header">
            <h3 id="mediaBrowserTitle">File ph∆∞∆°ng ti·ªán</h3>
            <span class="close"
                onclick="document.getElementById('mediaBrowserModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <div class="media-grid" id="mediaGridBody"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 15px;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Call Overlay -->
<div id="callOverlay" class="call-overlay">
    <!-- Incoming Call Alert -->
    <div id="incomingCallModal" class="incoming-call-modal">
        <div class="incoming-content">
            <div class="incoming-avatar" id="incomingAvatar">?</div>
            <h3 id="incomingName">User Name</h3>
            <p>Incoming Call...</p>
            <div class="incoming-actions">
                <button class="btn-circle btn-reject" id="btnRejectCall"><i class="fas fa-phone-slash"></i></button>
                <button class="btn-circle btn-accept" id="btnAcceptCall"><i class="fas fa-phone"></i></button>
            </div>
        </div>
    </div>

    <!-- Active Video Call - Discord Style -->
    <div id="activeCallView" class="active-call-view">
        <!-- Header Bar -->
        <div class="call-header">
            <div class="header-left">
                <i class="fas fa-volume-up"></i>
                <span id="callChannelName">General</span>
                <span class="header-divider">|</span>
                <span id="callerInfo">User is streaming</span>
            </div>
            <div class="header-right">
                <span class="quality-badge" id="qualityBadge">720p 30FPS</span>
                <span class="live-indicator" id="liveIndicator">LIVE</span>
                <button class="header-icon-btn" id="btnToggleChat" title="Toggle Chat"><i
                        class="fas fa-comment-alt"></i></button>
                <button class="header-icon-btn" id="btnFullscreen" title="Fullscreen"><i
                        class="fas fa-expand"></i></button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="call-main-content">
            <!-- Primary Stream/Screen Share -->
            <div class="primary-stream" id="primaryStream">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="primary-placeholder" id="remotePlaceholder"
                    style="display:none; position:absolute; inset:0; background:#0f172a; align-items:center; justify-content:center; color:#64748b; flex-direction:column; z-index:5;">
                    <i class="fas fa-user-circle" style="font-size: 8rem; margin-bottom: 2rem;"></i>
                    <span style="font-size: 1.5rem; color: #94a3b8;">Audio Only</span>
                </div>
                <div class="stream-overlay">
                    <div class="stream-name" id="remoteNameTag">Remote User</div>
                </div>
                <div class="call-status-badge" id="callStatus">Connecting...</div>
            </div>

            <!-- Call Chat Panel -->
            <div class="call-chat-panel" id="callChatPanel">
                <div class="call-chat-header">
                    <span><i class="fas fa-comments"></i> Live Chat</span>
                    <button class="call-chat-close" id="btnCloseCallChat" title="Close Chat">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="call-chat-messages" id="callChatMessages">
                    <!-- Messages will be added here -->
                    <div class="call-chat-empty">
                        <i class="fas fa-comment-dots"></i>
                        <span>Ch∆∞a c√≥ tin nh·∫Øn n√†o</span>
                    </div>
                </div>
                <div class="call-chat-input-area">
                    <input type="text" class="call-chat-input" id="callChatInput" placeholder="Nh·∫≠p tin nh·∫Øn..."
                        autocomplete="off">
                    <button class="call-chat-send" id="btnSendCallChat" title="Send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Participant Strip at Bottom -->
        <div class="participant-strip" id="participantStrip">
            <div class="participant-item" id="localParticipant">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="participant-name">You</div>
                <div class="participant-status" id="localMicStatus">
                    <i class="fas fa-microphone"></i>
                </div>
            </div>
            <!-- More participants will be added dynamically -->
        </div>

        <!-- Control Bar -->
        <div class="call-controls-bar">
            <div class="controls-left">
                <!-- Optional: stream info -->
            </div>
            <div class="controls-center">
                <button class="control-btn" id="btnToggleMic" title="Mute Mic">
                    <i class="fas fa-microphone"></i>
                    <span class="btn-chevron"><i class="fas fa-chevron-up"></i></span>
                </button>
                <button class="control-btn" id="btnToggleCam" title="Toggle Camera">
                    <i class="fas fa-video"></i>
                    <span class="btn-chevron"><i class="fas fa-chevron-up"></i></span>
                </button>
                <button class="control-btn" id="btnShareScreen" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="control-btn" id="btnGridView" title="Grid View">
                    <i class="fas fa-th"></i>
                </button>
                <button class="control-btn" id="btnMoreOptions" title="More Options">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <button class="control-btn btn-disconnect" id="btnEndCall" title="Disconnect">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            <div class="controls-right">
                <button class="control-btn control-btn-sm" id="btnPiP" title="Picture in Picture">
                    <i class="fas fa-external-link-square-alt"></i>
                </button>
                <button class="control-btn control-btn-sm" id="btnPopout" title="Pop Out">
                    <i class="fas fa-expand-alt"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    (function () {
        window.chatUserId = Number('{{ session.get("user_id", 0) }}') || 0;
        window.chatUserName = '{{ session.get("user_name", "User") }}';
        window.chatSessionId = localStorage.getItem('chat_session_id');
        window.isChatAdmin = '{{ session.get("is_admin", False) }}'.toLowerCase() === 'true';
    })();
</script>
<script type="module" src="{{ url_for('static', filename='js/chat/app.js') }}"></script>
{% endblock %}